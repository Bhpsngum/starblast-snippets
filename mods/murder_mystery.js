/* Editable fields */
var energy_delay = 0.5; // Delay between each item spawns (in seconds)
var items_required = 3; // Item needs to be collected to earn one shot
var detective_reload_time = 10; // Delay between each detective's shots
var player_laser_speed = 300; // Speed of each player's shots (execpt murderers)
var murderer_reload_time = 5; // Delay between each murderer's shots
var waiting_time = 30; //waiting time when server get enough players (in seconds)
var game_duration = 20; // duration of the game (in minutes)
var regen_factor = false; // regen factor of the players (inlcuding murderers)
/* End of editable fields */

/*
The rest are game mechanics.
DO NOT fix anything below this line unless you know what you're doing
*/
var capacity = 200*items_required;
var shield = capacity-100;
var specs = JSON.stringify({
  specs: {
    shield: {
      capacity: [shield,shield],
      reload: [1,1]
    },
    generator: {
      capacity: [capacity,capacity]
    },
    ship: {
      mass: 675,
      speed: [155,155],
      rotation: [130,130],
      acceleration: [120,120]
    }
  }
}), dash = {
  dash: {
    rate: 1,
    burst_speed: [200,200],
    speed: [150,150],
    acceleration: [70,70],
    initial_energy: [100,100],
    energy: [20,20]
  }
}, laser = JSON.stringify({
  damage: [capacity,capacity],
  speed: [player_laser_speed, player_laser_speed],
  rate: 0.5,
  type: 2,
  recoil: 0,
  number: 1,
  error: 0
});
var mod = function(ship, handler) {
  typeof handler == "function" && [[],["typespec"]].forEach(i => {
    let param = ship;
    i.forEach(j => (param = param[j]));
    handler(param);
  });
}

var Template = '{"size":2.4,"bodies":{"body":{"section_segments":12,"offset":{"x":0,"y":0,"z":0},"position":{"x":[0,0,0,0,0,0,0,0,0,0],"y":[-90,-100,-60,-10,0,20,50,80,100,90],"z":[0,0,0,0,0,0,0,0,0,0,0]},"width":[0,5,20,25,35,40,40,35,30,0],"height":[0,5,40,45,40,60,70,60,30,0],"texture":[10,2,10,2,3,13,13,63,12],"propeller":true,"laser":{}},"front":{"section_segments":8,"offset":{"x":0,"y":-20,"z":0},"position":{"x":[0,0,0,0,0],"y":[-90,-85,-70,-60,-20],"z":[0,0,0,0,0]},"width":[0,40,45,10,12],"height":[0,15,18,8,12],"texture":[8,63,4,4,4],"propeller":true},"propeller":{"section_segments":10,"offset":{"x":40,"y":40,"z":0},"position":{"x":[0,0,0,0,0,0,0,0,0,0],"y":[-20,-15,0,10,20,25,30,40,70,60],"z":[0,0,0,0,0,0,0,0,0,0]},"width":[0,10,15,15,15,10,10,20,15,0],"height":[0,10,15,15,15,10,10,18,8,0],"texture":[4,4,10,3,3,63,4,63,12],"propeller":true},"sides":{"section_segments":6,"angle":90,"offset":{"x":0,"y":0,"z":0},"position":{"x":[0,0,0,0,0,0,0,0,0,0],"y":[-80,-75,-60,-50,-10,10,50,60,75,80],"z":[0,0,0,0,0,0,0,0,0,0]},"width":[0,30,35,10,12,12,10,35,30,0],"height":[0,10,12,8,12,12,8,12,10,0],"texture":[4,63,4,4,4,4,4,63,4]},"cockpit":{"section_segments":12,"offset":{"x":0,"y":-20,"z":30},"position":{"x":[0,0,0,0,0,0,0,0],"y":[-50,-20,0,10,30,50],"z":[0,0,0,0,0,0]},"width":[0,12,18,20,15,0],"height":[0,20,22,24,20,0],"texture":[9]}},"wings":{"top":{"doubleside":true,"offset":{"x":0,"y":20,"z":15},"length":[70],"width":[70,30],"angle":[90],"position":[0,30],"texture":[63],"bump":{"position":10,"size":30}},"top2":{"doubleside":true,"offset":{"x":0,"y":51,"z":5},"length":[70],"width":[50,20],"angle":[90],"position":[0,60],"texture":[63],"bump":{"position":10,"size":30}}},"typespec":{"code":null,"shape":[5.28,5.25,5.332,5.393,4.944,1.997,1.745,1.556,1.435,3.587,3.81,3.779,3.838,3.84,3.779,3.81,3.587,3.205,3.571,3.9,5.132,5.888,5.835,5.551,4.886,5.808,4.886,5.551,5.835,5.888,5.132,3.9,3.571,3.205,3.587,3.81,3.779,3.838,3.84,3.779,3.81,3.587,1.435,1.556,1.745,1.997,4.944,5.393,5.332,5.25],"lasers":[{"x":0,"y":-4.8,"z":0,"angle":0,"spread":0,"error":0,"recoil":0}],"radius":5.888}}';
var Ghost_104 = '{"name":"Ghost","level":1,"model":4,"size":0.025,"zoom":0.075,"specs":{"shield":{"capacity":[1e-30,1e-30],"reload":[1000,1000]},"generator":{"capacity":[1e-30,1e-30],"reload":[1,1]},"ship":{"mass":1,"speed":[200,200],"rotation":[1000,1000],"acceleration":[1000,1000]}},"bodies":{"face":{"section_segments":100,"angle":0,"offset":{"x":0,"y":0,"z":0},"position":{"x":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"y":[-2,-2,2,2],"z":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},"width":[0,1,1,0],"height":[0,1,1,0],"vertical":true,"texture":[6]}},"typespec":{"name":"Ghost","level":1,"model":4,"code":104,"specs":{"shield":{"capacity":[1e-30,1e-30],"reload":[1000,1000]},"generator":{"capacity":[1e-30,1e-30],"reload":[1,1]},"ship":{"mass":1,"speed":[200,200],"rotation":[1000,1000],"acceleration":[1000,1000]}},"shape":[0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001],"lasers":[],"radius":0.001}}';
var roles = [
  {
    name: "Murderer",
    isMurderer: true,
    description: "Kill all detectives and innocents to win the game!",
    percentage: 20,
    modifier: function (ship) {
      let t = capacity/murderer_reload_time, g = capacity+100;
      ship.specs.generator = {
        capacity: [g,g],
        reload: [t,t]
      }
    },
    lasers: function (ship) {
      Object.assign(ship.specs.ship,dash);
      let h = new Array(2).fill(Number.MIN_VALUE);
      ship.bodies.body.laser.speed = h;
      ship.typespec.lasers[0].speed = h
    }
  },
  {
    name: "Detective",
    isMurderer: false,
    description: "Find and kill all the murderers!",
    percentage: 20,
    modifier: function (ship) {
      let t = capacity/detective_reload_time;
      ship.specs.generator.reload = [t,t];
    }
  },
  {
    name: "Innocent",
    isMurderer: false,
    description: "Collect "+items_required+" energy refills to have a chance to kill the murderers!",
    percentage: 40,
    modifier: function (ship) {
      ship.specs.generator = {
        reload: new Array(2).fill(Number.MIN_VALUE),
        capacity: new Array(2).fill(Number.MAX_VALUE)
      }
    }
  }
]
var getRole = function(id) {
  return (roles[id]||{}).name||"Ghost";
}
let start = 0;
var ships = Array(roles.length).fill(0).map((v,i) => {
  let pship = JSON.parse(Template);
  mod(pship, function(ship){
    ship.name = getRole(i);
    ship.level = 1;
    ship.model = ++start;
    Object.assign(ship,JSON.parse(specs));
  });
  pship.typespec.code = pship.level * 100 + pship.model;
  pship.bodies.body.laser = JSON.parse(laser);
  Object.assign(pship.typespec.lasers[0], JSON.parse(laser));
  let shipRole = roles[(pship.model - 1) % 3] || {};
  mod(pship, function (ship) {
    let resolver = shipRole.modifier;
    if ("function" == typeof resolver) resolver(ship)
  });

  let laserChange = shipRole.lasers;
  if ("function" == typeof laserChange) laserChange(pship);
  return pship
});

ships = ships.map(ship=>JSON.stringify(ship));
ships.push(Ghost_104);
var map = "99999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\n"+
"99999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\n"+
"99999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\n"+
"99999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\n"+
"99999                        1 9                                                                                                  1                     1                                          99999\n"+
"9999              1  11        9               1                    1                         1                                                      11         1   11          1                   9999\n"+
"999                      1     9                      1         1        1   1                  1 1  1                       1                    1         1      1 1     1      1    1   1         999\n"+
"999     1                      9                    1   1                    111            1  1       1                                 1                                           1      1   1    999\n"+
"999    1                       9            1   1       1    1           1        1   1           1          1                                1   11                               1 1        1   1  999\n"+
"999     9      1  1            9               1                       1                                              1        1 1              1                                    1     1         999\n"+
"999   1 99           999999999999999999999         9        1        1   9          5555555555555555555555555    1 11       11                 999999999999999999999999999999999                     999\n"+
"999     959           95555555555555555559 1 11    99     1         1   99          5555555555555555555555555  1    1     1                   999999999999999999999999999999999      1  1  1         999\n"+
"999     9559           9599999955555999959   1 1   9 9       1  1  1   9 9        1 5555555559999999555555555           1     1  1           999999995999999999999999999999999        1  1       1   999\n"+
"999     95959     1     959999999599999959         9  9     1         9  9     1    5555555999999999995555555       1  1   1 11             999999999959999999999999999999999         11      9      999\n"+
"999     959959           95999999559999959  1  1   9   9       1     9   9          5555559999999999999555555               1  1     1     999999999999599999999999999999999          1 1    99    1 999\n"+
"999  1  9599959           9599999595999959 1   1   9    9           9    9    1     5555599199999999999955555  1    1           1           9999999999995999999999999999999            1    919  1   999\n"+
"999  1  95999959   1 1     959999599599959    11   9    99    1    9     9   1 1    5555991191999111111995555                                99999999999959999999999999999         1       9119  1   999\n"+
"999 1   959999959           95999599959959 11 1    9    999       9      9   11     5559911911111111111999555                                 999999999999599999999999999      11         91119    1 999\n"+
"999     9599999959           9599999995959   11    9    9999     9       9    1     5559919111111111111999555                  1               9999999999599999999999999         1       911119  1   999\n"+
"999     95955599959     1     959999999559 11 1    9    99999   9        9          5599991111111199111999955              1         1          99999999599999999999999         1 1     9111119      999\n"+
"999     95599959959            95555555559    1    9    999999 9         9     1    5599999111111999111999955        9                           999999599999999999999       1         91111119      999\n"+
"999     95599999959         1   9999999999     1   9    9999999     1    9          5599999911119991111999955         9                           9999599999999999999     1 1         911111119  1   999\n"+
"999     95599999959                                9                     9          5599999991119911119999955          9           3               99599999999999999                 9111111119   1  999\n"+
"999     95955599959 1                          1   9                     9          5599999919111111119999955 1 1       9         3 3        11     999999555555999         1       91111111119      999\n"+
"999   1 95999959559         1                1 1   9     111             91         5599999911911111119999955            9       3   3               9999999999999          1      911111111119      999\n"+
"999 1   95999959559     9           1      11  11 19                     9          5599999191191111111999955     111     9     3     3               999999999991       1  111   9111111111119      999\n"+
"999     95599959555     99  1     1       11   1   9                     9      1   5559991119119111119999555       1      9  13       9       1       999999999   1             91111111111119      999\n"+
"999 1   95955599555     999  1  1       1    1     9                     9          5559991111999911181199555  1  1         9 3        99               9999999                 911111111111119      999\n"+
"999     95999999555     999   1                    9                1    9    1     5555911119999991811995555       111      9    1    919               99999        1   1    9111111111111119  1   999\n"+
"999     95999999555  1  999                        9                     9          5555511999999999119955555     11   1    99         9119        1      999           1 1   91111111111111119  11  999\n"+
"999     95999999555  1   99      999999999999999999999999999999     1    9          5555119999999999999555555              9 9        191119      1        9        1        911111111111111119      999\n"+
"999     95999999555    1  9      9    1 1                     9       1  9          5555555999999999995555555     1       9  9         911119               3        1   1  9111114444411111119      999\n"+
"999  1  95999999555  1  1 9      9          1                 9          9          5555555559999999555555555       1    9   9         9111199     11        3             91111994411145111119  11  999\n"+
"999 1   95999999555  1  1 9      9                 1          9          9          5555555555555555555555555           9    9         91119199       1       3           911119941131111611119   1  999\n"+
"999  1  95999999555       9    1 9          1     1           9          9      1   5555555555555555555555555          9     9  1     1911911919               3         9111199411181114161119      999\n"+
"999 1   95999999555     1 9      9              1   11  1                 9     1                               11    9      9         9191119119               3       91111194111838111491119  1   999\n"+
"999  1  95999999555  1    9      999999999999     9                 1      9      1                           1      9       9         99111191119      1        3     911111954118131811499119   1  999\n"+
"999  1  95999999555       9      9    9           9                         9        1                      1   1   9        9    1   1911111911119      1 1      3   9111111951181131181499119   1  999\n"+
"999     95999999555       9      9    9           9                          9                              1 1 1  9         9    1    9111119111119               3 91111111953833333338499119   1  999\n"+
"999     959999 9555     1 9 1    9    9   11 1    9                     1     9           1                       9          9      1  91111191111119               911111111951181131181499119   1  999\n"+
"999 1   95999   955       9      9    9           9                            9       1              1 1   1    9           9         911111911111119               91111111911118131811499119   1  999\n"+
"999     9599     95     1 9 1    9    9           9                  1          9              1  1             9            9         9111119111111119               9111111174111838111181119   1  999\n"+
"999 1   959       9       9      9  1 9        1  9       1                      9                             9        1    9   1     91111199999999999       1       911111171411181111881119      999\n"+
"999     99         9 1 11 9      9    9           9                               9                           9              9         911111911111111999               91111117144444418811119   1  999\n"+
"9991    9           9     9      9    9999999     999999  1   9                    9                         9               9  1      9111119111111191919      11       9111111751111158111119      999\n"+
"999    9             9    9      9                9           9                     9999999999999999999999999       1      1 9         91111191111119119119     1         911111115555511111119      999\n"+
"999   9          1    9   9      9  1         1   9           9                    9                                         9         911111911111911191119               91111111111111111119      999\n"+
"999  9          1      9  9      9    1           9           9                   9                                          9         9111119111191111911119        1      9111111111111111119      999\n"+
"999 9           1       9 9      9                9  1        9                  9                                           9         99999999999111119111119               911111111111111119      999\n"+
"9999                1    99      9          1     9      1 1  9      1          9  1                                         91        911111111991111191111119               91111111111111119   1  999\n"+
"999       1               9999999999999999999999999           9      1         9  1                             1  1         9        19111111191911111911111119               9111111111111119  11  999\n"+
"999                                                           9               9               1 1                            9         91111119119111119111111119   1   1       911111111111119      999\n"+
"999                     1                            1   1    9              9                                                         911111911191111191111111119               91111111111119   1  999\n"+
"999                   1 1             1             11        9             9                                                          9111191111999999999999999999  1 11         9111111111119      999\n"+
"999           9           1      1   1    1 1  1              9            9                                                      1    91119111119111111111111111199    1          911111111119      999\n"+
"999          959                1                   1         9           9                                       1                    911911111191111111111111119119               91111111119      999\n"+
"999   1     95959                                             9          9                                1                            9191111111911111111111111911119               9111111119      999\n"+
"999        9599959                                            9         9                                                              99111111119111111111111191111119               911111119      999\n"+
"999       95999995999999999999999999999999999999999999999999999        99999999999999999999999999999999      1                         99999999999999999999999999999999999  1          91111119      999\n"+
"999      95999999955555555555555559         999999999999999999                                                                1                 9911119991119991119991119               9111119      999\n"+
"999     95999999599599999999999959         955555555555555559                                                                                   919119191919191919191919                 911119      999\n"+
"999     9599999959995999999999959         959999999999999959                                                                                    91199119119119119119119                   91119      999\n"+
"999     959999955599599999999959    1    959999999999999959                                                                                     9199911919111919191919                     9119      999\n"+
"999     95999995959959999999959     1   959999999999999959                                                                                      991119199191199111999                       919      999\n"+
"999     9599995595595999999959    1    959999999999999959                                                                                       99999999111919999999                         99      999\n"+
"999  1  959999599959599999959  111    999999999999999959                                                                                        9911119999999991119             1             9      999\n"+
"999     95999555555559999959         959999999999999959           9999999999999999                                    9999999999999999          919119919111991919                            9      999\n"+
"999  1  9599959599955999959   1  1  9599999999999999959           9999999                                                      9999999          91199191191919119                 11          9   1  999\n"+
"999     959955995995599959    1    95999999999999999959           99999                                                          99999          9119119119911919                              9   1  999\n"+
"999     95955999959959959         959999999999999999959           9999                               1                            9999          919191919119199                          1    9      999\n"+
"999     9559599999595959  111    9599999999999999999959           999                                 1                            999          99111999111199        1                       9      999\n"+
"999     959999999995559         95999999995555999999959           99                                                                99   1      9999999999999   1             1               9      999\n"+
"999    1 9599999999959         959999999995999599999959           99                        1                                       99          991119991119                                  9      999\n"+
"999       95999999959     1   9599999999995999599999959           9                                                                  9          91919191919                        1          9   1  999\n"+
"999        959999959  1       9599999999995999599999959           9                                                                  9          9119119119                                    9      999\n"+
"999         9599959     1    1 959999999995555999999959           9           1                           1                          9          919191919                                     9 1    999\n"+
"999          95959    1         95999999995999599999959           9                                                                  9          99111999     1      99999          1          9  1   999\n"+
"999   1  1    959                9599999995999599999959           9             1                                                    9          9999999            9111119                    9  1   999\n"+
"999            9     1 1          959999995999599999959           9                                99                                9          991119            911111119                   9      999\n"+
"999                 1   9          95999995555999999959           9                               9999                               9          91919     1       911199999                   9      999\n"+
"999              1 1   959          9599999999999999959           9                              919919                              9   1      9119              9119222229                  9      999\n"+
"999               1   95559          955999999999999959           9                             91199119                             9          919              99119222219                  9      999\n"+
"999    1 1   1 1     9595959          95995999999999959           9               999999999999991119911199999999999999               9  1       99              919119111119      1 1     1   9      999\n"+
"999        1 1    1 959959959         95995999999999959                           991111191111911119911119111191111199                  1       9  1            92911199999                   9      999\n"+
"999       1        95999599999        95995999999999959                           919111191119111119911111911191111919                                          92911111119            1      9  1   999\n"+
"999       1       9599995999999       95995999999999959                           911911191191111119911111191191119119                                          92911111119                   9      999\n"+
"999        1     959999959999999      95595999999999959                           911199991911111119911111119199991119                     1                    92921111119                   9      999\n"+
"999     1       95999999599999959     95995999999999959                           911199119999999999999999999911991119                                          92922111129                   9      999\n"+
"999    1       959999999599999959     95995555599999959                           911191911911111199991111119119191119                                9999999999 9922222229                   9      999\n"+
"999           9599999999599999959     95999995999999959                           999991191191111919919111191191199999                 1             9191919119   922299929                   9      999\n"+
"999          95999999999599999959     95999995999999959                           911119119119119119911911911911911119                              9191919119    9229 9229                   9      999\n"+
"999         959999999999599999959     95999959599999959                           911199911911991119911199119119991119                             9191919119     9229 9229        777777     9      999\n"+
"999        9599999999999599999959     95999959599999959                           911919191191191119911191191191919119                            91919191199      99   99         777777     9 1    999\n"+
"999       95999999999999599999959     95999599959999959                           919119119119119119911911911911911919                           9191919119339                         77     9      999\n"+
"999      959999999999999599999959     95999555559999959                           991119111911911919919119119111911199                          919191911933339                  99999999999999 1    999\n"+
"999     9599999955599999599999959     95995999995999959                           911119111991191199991191199111911119          1              999999999933339                   99999999999999      999\n"+
"999     9599999959959999599999959     95995999995999959                          91111191191191199999999119119119111119                         9333333333339                          66     9      999\n"+
"999     9599999959995999599999959     95555555555555559                         9111111919111191999999991911119191111119                 1       93333333339                         6666     9      999\n"+
"999     9599999959995995955999959     99999999999999999                        911111119911111199999999991111119911111119                1        933333339               1          6666     9      999\n"+
"999     9599999959995959999555559                                             99999999999999999999999999999999999999999999                         9333339                                    9      999\n"+
"999     9599999959959599999955959                                             99999999999999999999999999999999999999999999                          93339                1                    9      999\n"+
"999     959999995959599999999959                                               911111119911111199999999991111119911111119          1           1     939                       1              9      999\n"+
"999     95999999559599999999959                                                 9111111919111191999999991911119191111119                              9                                       9      999\n"+
"999     9599999959599999999959                                                   91111191191191199999999119119119111119                    1                                                  9      999\n"+
"999     959999995595999999959                                            1        911119111991191199991191199111911119          1                                                   1         9      999\n"+
"999     95999999599959999959                                                      991119111911911919919119119111911199                                                                  1     9      999\n"+
"999     9599999559999599959                                                       919119119119119119911911911911911919                                                                        9      999\n"+
"999     959999595999995959                                                        911919191191191119911191191191919119                       11                                               9      999\n"+
"999     95999599999999959                                                         911199911911991119911199119119991119                             1           1                              9      999\n"+
"999     9599599999999959                                                          911119119119119119911911911911911119                                                      9999              9      999\n"+
"999     959599999999959                                                           999991191191111919919111191191199999                                                     999997             9      999\n"+
"999     95599999999959           9999999999999999999999       9                   911191911911111199991111119119191119                      1                              999997   99        9      999\n"+
"999     9555555555559             9                  9       9                    911199119999999999999999999911991119                                                     999997   9         9      999\n"+
"999     999999999999               9                9       9                     911199991911111119911111119199991119                                                     9999999999999      9      999\n"+
"999                            11   9              9       9                      911911191191111119911111191191119119          1           1                              99999999999999     9   1  999\n"+
"999                                  9            9       9                       919111191119111119911111911191111919                   1         9999999999999999        999999999999999   99      999\n"+
"999                                   9          9       9               1        991111191111911119911119111191111199                            999999999999999999       99199999999999999999      999\n"+
"999                      9             9                9         9      1        999999999999991119911199999999999999               9            999999999999999999    1  99999999999999999119      999\n"+
"999                       9             9              9          9                             91199119                    1        9   1        999999999999999999        9999999999999991119   1  999\n"+
"999                        9      1      9            9           9                              919919                              9   1        999999999111199999              9999999991119      999\n"+
"999                         9             9          9            9                               9999                               9            999999991111199999               999999999199   1  999\n"+
"999                          9             9        9             9                                99                      1         9            999999991199999999               999999999999      999\n"+
"999                           9    11       9                     9                                                                  9            999999991199999999                999999    9      999\n"+
"999                            9     1       9                    9                                                                  9            999999991199999999                99999     9      999\n"+
"999999999999999999999999999999999             9                   9                                                                  9            999991111111199999               99999      9      999\n"+
"999555555555555555555555555555599             9                   9             1                                                    9            999991111111999999         1    99999       9      999\n"+
"9995999999999999999999999999959 9             9                   9                                                                  9            999999991199999999            999999        9   1  999\n"+
"999599999999999999999999999959  9             9                   99                                1        1  1                   99   1        999999991199999999       1                  9      999\n"+
"99959999555999999999999999959   9      1      9                   99                                                                99            999999991199999999       1                  9      999\n"+
"9995999599999999999999999959    9             9                   999                                                              999            999999991199999999                          9      999\n"+
"999599959999999999999999959     9             9                   9999                                                            9999        1   999999991199999999                          9      999\n"+
"99959995999999999999999959      9             9                   99999                                                          99999            999999991199999999     1                    9      999\n"+
"9995999955599999999999959       9     1       9                   9999999                                                      9999999             9999999999999999       1                   9      999\n"+
"999599999995999999999959        9     1       9                   9999999999999999                                    9999999999999999          1                                             9      999\n"+
"99959999999599999999959         9             9                                                                                                                        1                  1   9      999\n"+
"9995999999959999999959    1     9       1     9                                                                       1                                        1  1    1                      9      999\n"+
"999599995559999999959           9       1     9                                                                                                                                               9      999\n"+
"99959999999999999959     1      9             9                                                                                                                                      1        9      999\n"+
"9995999555559999959             9       1     9                                                          1                                                                                    9      999\n"+
"999599999599999959              9             999999999999999999999                       9                                                       1       11                1                 9      999\n"+
"99959999959999959         1     9                                  9                       9                                      99999999999999                                              9      999\n"+
"9995999995999959                9    1                              9                       9                  1  1 1            9111111111111119                            1          1     9      999\n"+
"999599999599959                 9                                    9                       9                                   9111111111111119        1      1                             9      999\n"+
"99959999959959                  9      1                              9                       9                                  9111119111111119                                 1           9      999\n"+
"9995999999959                   9                                      9                       9          1         1  1         9111119911111119           1                 1     1         9      999\n"+
"999599999959            1       9                              11       9                       9               11               9111119991111119                            1               99      999\n"+
"99959999959                     9       1             11 1        1      9                       9                               9111119999111119                    888                    919      999\n"+
"9995999959                     9 3      1 1                               9                       9                    1         9111119991111119                   8458                   9119      999\n"+
"999599959        1            9   3         1         1                    9                       9                1            9111119911111119                  84548   1   9 9        91119   1  999\n"+
"99959959                     9     3                 1                      9                       9                            9111119111111119                 84548         9 9      911119      999\n"+
"9995959                     9       3                                        9                       9                           9111111111111119                84548           9 9    9111119      999\n"+
"999559                     9         3               1        1               9                       9                1         9111111111111119               84548           9 9    91111119   1  999\n"+
"99959                     9           3          1                             9                       9                          99999999999999          88   84548             9 9  911111119      999\n"+
"9999                     9             3                 1        1             9                       9       1                                         898 84548                 99111111119      999\n"+
"999                     9               3                             1          9                       9                                                 8974548      1           91111111119    1 999\n"+
"999                    9  1         1    3                                        9                       9                                                898548                  911111111119      999\n"+
"999                   9                   3                                        9                       9            1        1                          8988                  9111111111119      999\n"+
"999        1         9                     3                                1       9                       9                 1                            668998                91111111111119      999\n"+
"999                 9 1   1                 3                                        9                       9                1                           666 8898              911111111111119      999\n"+
"999                9      1                  9999999999999999999999 1 1               9                       9                                         8866    88             9111111111111119      999\n"+
"999               9    1                    9                    9                     9                       9    1  1                                898                   91111111111111119     1999\n"+
"999              9           9             9                    9   1           1       9                       9                                       888                  911111111111111119      999\n"+
"999             9           9    11       9                    9      1                  9                       9                                                  1       9111111111111111119      999\n"+
"999            9           9             9                    9            9              9                       9                   1     1                              91111111111111111119      999\n"+
"999           9  1        9             9                    9   1        9                9                       9                                                      911111176111166111119      999\n"+
"999          9           9             9                    9            9   1       1      9                       9            1       1       1                       9111111861111116811119      999\n"+
"999         9           9   1         9          1         9            9                    9                       9                 111                              91111119999999999991119     1999\n"+
"999        9           9             9              1     9 1          9         1 1          9                       9     1                                          911111199999999999999119      999\n"+
"999   1   9           9             9            1       9            9                  1     9                       9       1   1           1              1       9111111199911999991199119      999\n"+
"999      9           9             9          1         9            9        1           1     9                       9                             1              91111111999911999991199919      999\n"+
"999     9    11     9 1           9          1         9            9                            9                       9                 1  1                     911111111999999999999999919      999\n"+
"999     9    1     9             9          1         9   1        9          1          1        9                       9    1       1 1                         9111111111999999999999999919      999\n"+
"999     9         9             9        1 1         9            9                 9  1           9                       9              1   1                   91111111111999199999999199919      999\n"+
"999     9        9             9          1         9            9                 9 9              9                       9                                    911111111111999911111111999919     1999\n"+
"999  1  9       9             9                    9            9                 9   9        1     9                       9                    111           9111111111111999999111199999919      999\n"+
"999     9      9     1       9                    9   1 1      9                 9     9          1   9                       9    1                1          91111111111111199991111119999119      999\n"+
"999     9     9             9                    9     1      9         1 1     9       9              9                       9   1                          911111111111111111111111111111119      999\n"+
"999     9    9             9                    9            9                 9         9     1        9                       9                            9111111111111111111111111111111119      999\n"+
"999     9   9             9       1            9            9                 9           9       1      9                       9 1                        99999999999999999999999999999999999      999\n"+
"999     9  9             9                    9            9       1         9             9              9                     9                                             9                      999\n"+
"999     9 9             9          1         9            9                 9               9              9                   91            1             1       1          9                      999\n"+
"999  1  99    1        9                    9            9                 9                 9     1        9                 9         11                                    9             1      1 999\n"+
"999     9  1 1        9                    99999999999999                 9        1          9              9               9                                                9       1         1    999\n"+
"999      111         9                    9                              9        1            9              9             9                                       1         9     1                999\n"+
"999                 9        1           9    1                      1  9                       9              9           9       11                 1                1    1 9                      999\n"+
"999                9                    9      1                       9      1                  9     1        9         9                                                   9                      999\n"+
"999               9   11               9                              9                      1    9              9       9     1            9               1                19                      999\n"+
"999              9                    9                     111      9    11                       9              9     9                  999                      11        9            9         999\n"+
"999             9                    9                11            9               9               9              9   9                  99999                               9             9        999\n"+
"999            9                    9           1                  9  1 1          999               9              9 9                  9999999          1             1                    9       999\n"+
"999           9                    9 1       1     1 1           19               99999               9999999999999999                  999999999                     1     1      1      1   9      999\n"+
"999           9            1 1    1          1 1         1                       9999999          1                      11     1      99999999999                                 1           9     999\n"+
"999           9                                                                 999999999                                      1      99999999999991          1   1           1    1    1       9    999\n"+
"999           9                      1  1                                      99999999999                        1     1            999999999999999                                             9   999\n"+
"9999          9                                                               9999999999999                1                        99999999999999999                    1                        9 9999\n"+
"99999         9                                                              999999999999999                                       9999999999999999999           1                                 99999\n"+
"999999        9                                                             99999999999999999                                     999999999999999999999                                           999999\n"+
"99999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\n"+
"99999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\n"+
"99999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999";
this.options = {
  // see documentation for options reference
  root_mode: "",
  map_name: "Starblast Murder Mystery",
  ships: ships,
  starting_ship: 103,
  lives: 5,
  reset_tree: true,
  max_players: 30,
  map_size: 200,
  asteroids_strength: 1e6,
  crystal_value: 0,
  radar_zoom: 0.99,
  auto_refill: true,
  shield_regen_factor: regen_factor===false?shield/20:regen_factor,
  lives: 0,
  custom_map: map
};
var coords = [], bmap = map.split("\n"), dfl_tcl = "hsla(210, 50%, 87%, 1)";
var rand = function(num) {
  return Math.floor(Math.random()*num)
}
for (let i = 0; i<bmap.length ; i++)
  for (let j = 0; j<bmap[i].length;j++) {
    let t = Number(bmap[i][j]);
    (!t || isNaN(t)) && coords.push([i,j])
  }
var randomSpawn = function () {
  let [y,x] = coords[rand(coords.length)];
  return {x: (x*2-game.options.map_size+1)*5,y: (game.options.map_size-y*2-1)*5}
}
var FormatTime = function(time) {
  var array = [Math.floor(time/3600), Math.floor((time%3600)/60)]
  return array.map(i => i<10?"0"+i.toString():i).join(":");
}
var toTick = sec => sec*60;
var wait = toTick(waiting_time), min_players = 5, total_players;
var announce = function(ship,...data) {
  ship.setUIComponent({
    id: "message",
    position: [25,10,50,50],
    visible: true,
    components: data.map((j,i) => ({type:"text",position:[0,10*i,100,10],value:j,color:dfl_tcl}))
  });
}

var setStats = function(ship) {
  ship.alive && ship.setUIComponent({
    id: "stat",
    position: [3,28,17,15],
    visible: true,
    components: [
      "Role: "+getRole(ship.custom.role),
      "Time left: "+FormatTime(game_time),
      ship.custom.role == 2 ? `Chances: ${Math.trunc(ship.generator / capacity)}` : ""
    ].flat().map((j,i) => ({type: "text",position:[0,25*i,80,25],value:j,color:dfl_tcl}))
  });
}
var game_players = Array(roles.length).fill(0), game_time;
var initialization = function(game) {
  roles[2].description = "Collect "+items_required+" energy refill"+(items_required==1?"s":"")+" to have a chance to kill the murderers!";
  this.tick = waiting
}, waiting = function (game) {
  if (game.step % 30 === 0) {
    game.ships.forEach(ship => ship.set({invulnerable: 60, generator: 0}));
    if (wait >= 0) {
      let required = min_players-game.ships.length, ps = "Waiting for more players" + ((required > 0)?` (${required} needed)`:"");
      if (required <= 0) {
        (wait % 60 === 0) && announce(game,ps,FormatTime(wait));
        wait-= 30;
      }
      else {
        wait = toTick(waiting_time);
        announce(game,ps);
      }
      // showMatchInfo();
    }
    else {
      game.setOpen(false);
      joined_players = game.ships.length;
      var players = roles.map(i=>Math.floor(joined_players*i.percentage/100)), randlist = game.ships.map((v,i) => i);
      players[2] = joined_players - players[0] - players[1];
      Preset: while (true) {
        let i = 0;
        while (players[i] === 0)
          if (i == players.length-1 || players.length == 0) break Preset;
          else i++;
        let index = rand(randlist.length), ship = game.ships[randlist[index]];
        ship.custom.role = i;
        ship.custom.role_init = i;
        ship.custom.frags = Array(roles.length).fill(0);
        ship.set(Object.assign(randomSpawn(),{generator:0,type:100+i+1,shield:shield}));
        announce(ship, "You are the "+getRole(i)+"!", roles[i].description);
        setTimeout(function(){
          announce(ship,"");
        },3000);
        randlist.splice(index,1);
        players[i]--;
      }
      game_time = toTick(game_duration*60);
      this.tick = main_game;
    }
  }
}, main_game = function(game) {
  if (game.step % 30 === 0) {
    game_players = Array(roles.length).fill(0);
    for (let ship of game.ships) {
      let rolei = ship.custom.role, role = roles[rolei];
      if (!role) ship.set({type: 104, collider: false});
      else if (ship.alive) game_players[rolei]++
    }
    if (game_time < 0 || game_players[0] == 0 || game_players[1] + game_players[2] == 0) ended.call(this, game);
    else {
      game.step % 60 === 0 && game.ships.forEach(setStats);
      game_time-=30
    }
  }
  if (game.step % (energy_delay*60) === 0 && game.collectibles.length < 50) {
    let f = randomSpawn();
    f.code = 90;
    game.addCollectible(f);
  }
}, ended = function (game) {
  let murderers = game_players[0], innocents = game_players[1]+game_players[2], winner;
  if (game_time < 0) winner = murderers>innocents?0:2;
  else winner = murderers == 0?2:0;
  announce(game, "Game finished!",getRole(winner)+" team wins!");
  setTimeout(function(){
    for (let ship of game.ships) {
      let ed = {
        "Winner": getRole(winner),
        "Your current role": getRole(ship.custom.role),
        "Your first role": getRole(ship.custom.role_init)
      }
      if (Array.isArray(ship.custom.frags)) ship.custom.frags.forEach((v,i) => (ed[getRole(i)+"s killed"] = v));
      ship.gameover(ed)
    }
  },5000);
  this.tick = null
}
this.tick = initialization;

this.event = function(event, game) {
  let ship = event.ship;
  if (ship) switch(event.name) {
    case "ship_destroyed":
      let kil = event.killer,killer = kil?(kil.name||"Unknown"):"", message = "You've "+(killer?"been killed by":"killed yourself"), sc = {};
      sc[message] = killer;
      if (kil && roles[((kil||{}).custom||{}).role]) {
        if (!roles[kil.custom.role].isMurderer) kil.set({kill: true});
        kil.custom.frags[ship.custom.role]++
      }
      ship.custom.role = null;
      ship.set({type: 104, collider: false});
      ship.custom.pstats = sc;
      break;
  }
}
